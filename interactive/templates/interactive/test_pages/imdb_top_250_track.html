<!DOCTYPE html>
<html>
	<meta charset="utf-8">
	<style>

	body {
  font: 10px sans-serif;
}

.axis path,
.axis line,
.x.axis path {
  fill: none;
  stroke: #000;
  shape-rendering: crispEdges;
}

.line {
  fill: none;
  stroke: grey;
  stroke-width: .5px;
  opacity: 0.5;
}

.line:hover {
	stroke: red;
	stroke-width: 3px;
	opacity: 1;
}

div {
	margin-top: 20px;
	height: 450px;
	width: 300px;
	overflow: scroll;
	float: right;
}

tr {
	text-align: left;
}

tr:hover {
	background-color: lightgrey;
}

	</style>
	<head>
		<script src="d3.min.js"></script>
	</head>
	<body>
		<div>
			<table id="movie_selection">
				<thead>

					<tr>
						<th>Movie</th>
						<th>Year</th>
<!-- 						<th>Rank Upon Entering</th>
						<th>Date Upon Entering</th> -->
					</tr>
				</thead>
			</table>
		</div>
	</body>

			<script>

// margins for the svg - height/width defined in terms of margin
var margin = {top: 20, right: 20, bottom: 30, left: 50},
	width = 960 - margin.left - margin.right,
	height = 500 - margin.top - margin.bottom;

// takes in date from data, returns js-compatible date
var parseDate = d3.time.format("%d-%b-%y").parse;

// scales the x values - expects dates, outputs width range
var x = d3.time.scale()
	.range([0, width]);

// scales the y values - expects continuous data set, outputs height range
var y = d3.scale.linear()
	.range([height, 0]);

// stores x axis based on x scale as defined above
var xAxis = d3.svg.axis()
	.scale(x)
	.orient("bottom");

// stores y axis based on y scale as defined above
var yAxis = d3.svg.axis()
	.scale(y)
	.orient("left");

// stores a d3 line that is bound to scaled data - it's called below (after data is loaded)
var line = d3.svg.line()
	.x(function(d) { return x(d.date); })
	.y(function(d) { return y(d.rank); });

// svg is stored and appended to the body of the html
var svg = d3.select("body").append("svg")
	.attr("width", width + margin.left + margin.right)
	.attr("height", height + margin.top + margin.bottom)
	// find out what this does?
	.append("g")
	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

// loads data, makes it available to functions below as a set of objects
d3.csv("old_data_test_2.csv", function(error, data) {
	// coerces the data types correctly
	data.forEach(function(d) {
		d.rank = +d.rank;
		d.year = +d.year;
		d.num_votes = +d.num_votes;
		d.imdb_rating = +d.imdb_rating;
		d.date = parseDate(d.date);
	});

	// nest the data - make the movies the keys in an array of movie objects
	var nest = d3.nest()
		.key(function(d) { return d.title_key; })
		.entries(data);

	// for testing
	console.log(nest);

	dataTable = []

	nest.forEach(function(d) {
		var date = d.values[0].date
		var formattedDate = date.getMonth() + 1 + "-" + date.getDate() + "-" + date.getFullYear();

		dataTable.push([d.key, d.values[0].title, d.values[0].year]) //, d.values[0].rank, formattedDate
	})

	console.log(dataTable)

	x.domain(d3.extent(data, function(d) { return d.date; }));
	y.domain([d3.max(data, function(d) { return d.rank; }), 
				d3.min(data, function(d) { return d.rank; })
				]);

	// adding the x axis and all of its attributes
	svg.append("g")
		.attr("class", "x axis")
		.attr("transform", "translate(0," + height + ")")
		.call(xAxis);

	// adding the y axis and all of its attributes
	svg.append("g")
		.attr("class", "y axis")
		.call(yAxis)
		.append("text")
		.attr("transform", "rotate(-90)")
		.attr("y", 6)
		.attr("dy", ".71em")
		.style("text-anchor", "end")
		.text("Top 250 Rank");

	// loop through the nested data and make a line for every movie
	nest.forEach(function(d) {
		svg.append("path")
		.datum(d.values)
		.attr("class", "line " + d.key)
		.attr("d", line);
	});

	// for each movie title, add a row
	dataTable.forEach(function(d) {
		d3.select("#movie_selection")
			.append("tr")
			.attr("class", d[0])
		for(i=1; i < d.length; i++) {
			d3.select("." + d[0])
				.append("td")
				.text(d[i])
				.style("width", "200px")
				.style("overflow", "hidden")
		}
			// .append("tr")
			// .text(function(d) { return d.title; });		
	});

	// store all of the rows
	var tr = d3.selectAll("tr");

	// if you hover over a row, it highlights the line for the movie in the row
	tr.on("mousemove", function(d) {
		var movie = d3.select(this).attr("class");
		svg.select("." + movie)
			.style("stroke", "red")
			.style("stroke-width", "3px")
			.style("opacity", "1");
		})

	   .on("mouseout", function(d) {
	   	svg.selectAll(".line")
	   		.style("stroke", "grey")
	   		.style("stroke-width", ".5px")
	   		.style("opacity", "0.5");
	   	});

});

		</script>

</html>